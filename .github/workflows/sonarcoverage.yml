#name: .NET Coverage SonarQube
#
#on:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]
#
#jobs:
#  build:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Set up JDK 17 (required by SonarQube)
#        uses: actions/setup-java@v4
#        with:
#          java-version: 17
#          distribution: 'zulu'
#
#      - name: Checkout repository
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0  # full history improves SonarQube analysis relevance
#
#      - name: Setup .NET
#        uses: actions/setup-dotnet@v4
#        with:
#          dotnet-version: 9.0.x
#
#      - name: Cache NuGet packages
#        uses: actions/cache@v4
#        with:
#          path: ~/.nuget/packages
#          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
#          restore-keys: |
#            ${{ runner.os }}-nuget-
#
#      - name: Cache SonarQube packages
#        uses: actions/cache@v4
#        with:
#          path: ~/.sonar/cache
#          key: ${{ runner.os }}-sonar
#          restore-keys: ${{ runner.os }}-sonar
#
#      - name: Install SonarQube scanner
#        run: |
#          dotnet tool install --global dotnet-sonarscanner
#          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
#
#      - name: Restore dependencies
#        run: dotnet restore
#
#      - name: Begin SonarQube analysis
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: |
#          dotnet-sonarscanner begin \
#            /k:"PS222407_eshop_productservice" \
#            /o:"ps222407" \
#            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
#            /d:sonar.host.url="https://sonarcloud.io" \
#            /d:sonar.cs.vscoveragexml.reportsPaths="TestResults/**/*.xml" \
#            /d:sonar.coverage.exclusions="eshop_productservice/Migrations/**"
#
#      - name: Build project
#        run: dotnet build --no-restore --configuration Release
#
#      - name: Test with coverage
#        run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./TestResults
#
#      - name: End SonarQube analysis
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
#
#      - name: Upload test results
#        uses: actions/upload-artifact@v4
#        with:
#          name: test-results
#          path: ./TestResults
#
#      - name: Publish build artifact
#        run: dotnet publish --configuration Release --output ./publish --no-build
#
#      - name: Upload published artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: webapi-publish
#          path: ./publish
